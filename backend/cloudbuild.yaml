substitutions:
  _REGION: europe-west1
  _IMAGE_PATH: europe-west1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/laxmi-chit-fund:$COMMIT_SHA

steps:
  - name: "docker/compose:2.19.1"
    id: "build-tests"
    args: ["-f", "docker-compose-tests.yaml", "up", "-d"]
    dir: "backend"

  - name: "docker/compose:2.19.1"
    id: "run-tests"
    args:
      [
        "-f",
        "docker-compose-tests.yaml",
        "run",
        "-e",
        "PYTEST_ARGS=--maxfail=1 -v",
        "tests",
      ]
    waitFor: ["build-tests"]
    dir: "backend"

  - name: "gcr.io/cloud-builders/docker"
    id: "build-backend"
    args: ["build", "-t", "$_IMAGE_PATH", "."]
    dir: "backend"

  - name: "gcr.io/cloud-builders/docker"
    id: "push-backend"
    args: ["push", "$_IMAGE_PATH"]

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    id: "deploy-backend"
    args:
      - "run"
      - "deploy"
      - "laxmi-chit-fund"
      - "--image"
      - "$_IMAGE_PATH"
      - "--region"
      - "$_REGION"

images:
  - "$_IMAGE_PATH"
